# Copyright (c) 2025 VEXXHOST, Inc.
# SPDX-License-Identifier: Apache-2.0

---
- name: Parse provider resources into version mapping
  run_once: true
  ansible.builtin.set_fact:
    cluster_api_installed_core_version: "{{ cluster_api_providers.resources | selectattr('type', 'equalto', 'CoreProvider') | map(attribute='version') | first | regex_replace('^v', '') }}" # yamllint disable-line rule:line-length
    cluster_api_installed_bootstrap_version: "{{ cluster_api_providers.resources | selectattr('type', 'equalto', 'BootstrapProvider') | map(attribute='version') | first | regex_replace('^v', '') }}" # yamllint disable-line rule:line-length
    cluster_api_installed_control_plane_version: "{{ cluster_api_providers.resources | selectattr('type', 'equalto', 'ControlPlaneProvider') | map(attribute='version') | first | regex_replace('^v', '') }}" # yamllint disable-line rule:line-length
    cluster_api_installed_infrastructure_version: "{{ cluster_api_providers.resources | selectattr('type', 'equalto', 'InfrastructureProvider') | map(attribute='version') | first | regex_replace('^v', '') }}" # yamllint disable-line rule:line-length

- name: Calculate upgrade path for core providers
  run_once: true
  ansible.builtin.set_fact:
    _cluster_api_core_current_index: "{{ cluster_api_available_core_versions | ansible.utils.index_of('eq', cluster_api_installed_core_version) }}"
    _cluster_api_core_target_index: "{{ cluster_api_available_core_versions | ansible.utils.index_of('eq', cluster_api_core_version) }}"

- name: Validate core provider versions are known
  run_once: true
  ansible.builtin.fail:
    msg: |
      Unknown Cluster API core version detected.
      Installed version '{{ cluster_api_installed_core_version }}' or target version '{{ cluster_api_core_version }}'
      is not in the list of known versions: {{ cluster_api_available_core_versions | join(', ') }}
  when: _cluster_api_core_current_index == -1 or _cluster_api_core_target_index == -1

- name: Build core provider upgrade path
  run_once: true
  ansible.builtin.set_fact:
    _cluster_api_core_upgrade_path: "{{ cluster_api_available_core_versions[(_cluster_api_core_current_index | int + 1):(_cluster_api_core_target_index | int + 1)] }}"
  when: (_cluster_api_core_target_index | int) > (_cluster_api_core_current_index | int)

- name: Set empty upgrade path if no core upgrade needed or downgrade
  run_once: true
  ansible.builtin.set_fact:
    _cluster_api_core_upgrade_path: []
  when: (_cluster_api_core_target_index | int) <= (_cluster_api_core_current_index | int)

- name: Calculate upgrade path for infrastructure provider (OpenStack)
  run_once: true
  when: cluster_api_infrastructure_provider == 'openstack'
  block:
    - name: Get infrastructure version indices
      ansible.builtin.set_fact:
        _cluster_api_infra_current_index: "{{ cluster_api_available_infrastructure_openstack_versions | ansible.utils.index_of('eq', cluster_api_installed_infrastructure_version) }}"
        _cluster_api_infra_target_index: "{{ cluster_api_available_infrastructure_openstack_versions | ansible.utils.index_of('eq', cluster_api_infrastructure_version) }}"

    - name: Validate infrastructure provider versions are known
      ansible.builtin.fail:
        msg: |
          Unknown infrastructure-openstack version detected.
          Installed version '{{ cluster_api_installed_infrastructure_version }}' or target version '{{ cluster_api_infrastructure_version }}'
          is not in the list of known versions: {{ cluster_api_available_infrastructure_openstack_versions | join(', ') }}
      when: _cluster_api_infra_current_index == -1 or _cluster_api_infra_target_index == -1

    - name: Build infrastructure provider upgrade path
      ansible.builtin.set_fact:
        _cluster_api_infra_upgrade_path: "{{ cluster_api_available_infrastructure_openstack_versions[(_cluster_api_infra_current_index | int + 1):(_cluster_api_infra_target_index | int + 1)] }}"
      when: (_cluster_api_infra_target_index | int) > (_cluster_api_infra_current_index | int)

    - name: Set empty upgrade path if no infrastructure upgrade needed or downgrade
      ansible.builtin.set_fact:
        _cluster_api_infra_upgrade_path: []
      when: (_cluster_api_infra_target_index | int) <= (_cluster_api_infra_current_index | int)

- name: Set empty infrastructure upgrade path for non-OpenStack providers
  run_once: true
  ansible.builtin.set_fact:
    _cluster_api_infra_upgrade_path: []
  when: cluster_api_infrastructure_provider != 'openstack'

- name: Check for version jump in core providers
  run_once: true
  ansible.builtin.set_fact:
    _cluster_api_core_version_jump: "{{ (_cluster_api_core_upgrade_path | length) > 1 }}"
    _cluster_api_infra_version_jump: "{{ (_cluster_api_infra_upgrade_path | default([]) | length) > 1 }}"

- name: Display upgrade path information
  run_once: true
  ansible.builtin.debug:
    msg: |
      Cluster API Upgrade Analysis:
      =============================
      Core Provider:
        Current version: {{ cluster_api_installed_core_version }}
        Target version: {{ cluster_api_core_version }}
        Upgrade path: {{ _cluster_api_core_upgrade_path | default([]) | join(' -> ') or 'No upgrade needed' }}
        Multi-step upgrade required: {{ _cluster_api_core_version_jump }}

      Infrastructure Provider ({{ cluster_api_infrastructure_provider }}):
        Current version: {{ cluster_api_installed_infrastructure_version }}
        Target version: {{ cluster_api_infrastructure_version }}
        Upgrade path: {{ _cluster_api_infra_upgrade_path | default([]) | join(' -> ') or 'No upgrade needed' }}
        Multi-step upgrade required: {{ _cluster_api_infra_version_jump }}
  when: >
    (_cluster_api_core_upgrade_path | length) > 0 or
    (_cluster_api_infra_upgrade_path | default([]) | length) > 0

- name: Perform sequential core provider upgrades
  run_once: true
  when:
    - _cluster_api_core_upgrade_path | length > 0
  block:
    - name: Execute upgrade for each core version step
      ansible.builtin.include_tasks: upgrade_step.yml
      loop: "{{ _cluster_api_core_upgrade_path }}"
      loop_control:
        loop_var: _cluster_api_upgrade_core_version
        index_var: _cluster_api_upgrade_step
      vars:
        _cluster_api_upgrade_infra_version: >-
          {{
            _cluster_api_infra_upgrade_path[_cluster_api_upgrade_step]
            if (_cluster_api_upgrade_step < (_cluster_api_infra_upgrade_path | default([]) | length))
            else cluster_api_installed_infrastructure_version
          }}
        _cluster_api_is_final_step: "{{ _cluster_api_upgrade_step == ((_cluster_api_core_upgrade_path | length) - 1) }}"

- name: Perform remaining infrastructure upgrades (if infrastructure has more steps than core)
  run_once: true
  when:
    - _cluster_api_infra_upgrade_path | default([]) | length > _cluster_api_core_upgrade_path | length
  block:
    - name: Execute remaining infrastructure upgrade steps
      ansible.builtin.include_tasks: upgrade_step.yml
      loop: "{{ _cluster_api_infra_upgrade_path[(_cluster_api_core_upgrade_path | length):] }}"
      loop_control:
        loop_var: _cluster_api_remaining_infra_version
        index_var: _cluster_api_remaining_step
      vars:
        _cluster_api_upgrade_core_version: "{{ cluster_api_core_version }}"
        _cluster_api_upgrade_infra_version: "{{ _cluster_api_remaining_infra_version }}"
        _cluster_api_is_final_step: "{{ _cluster_api_remaining_step == ((_cluster_api_infra_upgrade_path | length) - (_cluster_api_core_upgrade_path | length) - 1) }}"

- name: Perform infrastructure-only upgrade (when core is already at target)
  run_once: true
  when:
    - _cluster_api_core_upgrade_path | length == 0
    - _cluster_api_infra_upgrade_path | default([]) | length > 0
  block:
    - name: Execute infrastructure upgrade steps
      ansible.builtin.include_tasks: upgrade_step.yml
      loop: "{{ _cluster_api_infra_upgrade_path }}"
      loop_control:
        loop_var: _cluster_api_upgrade_infra_version
        index_var: _cluster_api_upgrade_step
      vars:
        _cluster_api_upgrade_core_version: "{{ cluster_api_core_version }}"
        _cluster_api_is_final_step: "{{ _cluster_api_upgrade_step == ((_cluster_api_infra_upgrade_path | length) - 1) }}"
